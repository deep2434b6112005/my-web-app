<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WalkBuddy</title>

    <link rel="stylesheet" href="walk.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
      crossorigin="anonymous"
    />

    <!-- Leaflet CSS (Free Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  
  </head>

  <body>
    <!-- Header -->
    <header class="header">
      <nav class="navbar">
        <div class="logo">WalkBuddy</div>
      </nav>
    </header>

    <!-- About the App -->
    <section class="about-the-app">
      <div class="about-the-app-container1">
        <h1>Find walking buddies nearby â€” walk safer, walk happier</h1>
        <p>
          Connect with like-minded individuals in your community who share your
          passion for walking. Enjoy the benefits of exercise, fresh air, and
          great company.
        </p>
        <div class="button-group">
          <button class="btn-primary">Find a Walk</button>
          <button class="btn-secondary">Browse Buddies</button>
        </div>
      </div>
      <div class="image-container">
        <img src="image/walk2.webp" alt="Walking buddies" />
      </div>
    </section>

    <!-- Quick Book -->
    <section class="quick-book">
      <h1>Quick Book</h1>
      <div class="quick-book-grid">
        <div class="quick-card">
          <img src="image/morning1.webp" alt="Morning Stroll" />
          <h3>Morning Stroll ðŸŒ…</h3>
          <p>
            Kickstart your day with a refreshing walk. Connect with early birds
            and enjoy the quiet beauty of dawn.
          </p>
        </div>
        <div class="quick-card">
          <img src="image/evening1.webp" alt="Evening Walk" />
          <h3>Evening Walk ðŸŒ†</h3>
          <p>
            Unwind after a long day. Perfect for a relaxed pace and friendly
            chats as the day winds down.
          </p>
        </div>
        <div class="quick-card">
          <img src="image/week1.webp" alt="Weekend Hike" />
          <h3>Weekend Hike ðŸŒ²</h3>
          <p>
            Explore nature trails and challenge yourself with invigorating
            weekend excursions. Discover new routes!
          </p>
        </div>
      </div>
    </section>

<section id="dashboard">
      <h1>Your Walk Dashboard</h1>
      <div id="dashboard-content">
        <div class="dashboard-box">
          <h2>Walks Nearby</h2>
          <ul id="nearbyList">
            <li>Loading nearby walks...</li>
          </ul>
          <a href="map.html">View All Nearby Walkers â†’</a>
        </div>

        <div class="dashboard-box">
          <h2>Your Next Walk</h2>
          <div id="nextWalk">
            <p>Loading next walk...</p>
          </div>
          <a href="bookslot.html">View Details</a>
        </div>

        <div class="dashboard-box">
          <h2>Your Walk Buddies</h2>
          <ul id="buddyList">
            <li>Loading buddies...</li>
          </ul>
          <a href="friend.html">Manage Buddies</a>
        </div>
      </div>
    </section>

    <!-- Bottom Navigation -->
    <footer class="bar">
      <button onclick="window.location.replace('walk.html')">
        <i class="fa-solid fa-house"></i>Home
      </button>
      <button onclick="window.location.replace('map.html')">
        <i class="fa-solid fa-map-location-dot"></i>MAP
      </button>
      <button onclick="window.location.replace('friend.html')">
        <i class="fa-solid fa-user-friends"></i>FRIENDS
      </button>

      <button onclick="window.location.replace('bookslot.html')">
        <i class="fa-solid fa-bookmark"></i>BOOKING
      </button>
      <button><i class="fa-solid fa-user"></i>Profile</button>
    </footer>

    <script>
      // âœ… Slot booking
      document.querySelectorAll(".slot").forEach((img) => {
        img.addEventListener("click", async () => {
          const slotTitle = img.nextElementSibling.textContent;
          const confirmBooking = confirm(Book ${slotTitle}?);
          if (!confirmBooking) return;

          const today = new Date().toISOString().split("T")[0];

          const res = await fetch("/book", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              userEmail,
              buddyEmail: "buddy@example.com",
              slot: slotTitle,
              date: today,
            }),
          });

          const data = await res.json();
          alert(data.message);
        });
      });

      // Get logged in user from URL (like ?user=email@example.com)
      const urlParams = new URLSearchParams(window.location.search);
      const userEmail = urlParams.get("user");

      // ===== Load Nearby Users =====
      async function loadNearby() {
        if (!navigator.geolocation) {
          document.getElementById("nearbyList").innerHTML =
            "<li>Location not supported</li>";
          return;
        }

        navigator.geolocation.getCurrentPosition(async (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          const res = await fetch(/nearby?lat=${lat}&lng=${lng});
          const users = await res.json();

          const list = document.getElementById("nearbyList");
          list.innerHTML = "";

          if (users.length === 0) {
            list.innerHTML = "<li>No nearby walkers found</li>";
          } else {
            users.forEach((u) => {
              const li = document.createElement("li");
              li.textContent = ${u.name} (${u.email});
              list.appendChild(li);
            });
          }
        });
      }

      // ===== Load Next Walk =====
      async function loadNextWalk() {
        const res = await fetch(/invites?email=${userEmail});
        const invites = await res.json();
        const nextWalkDiv = document.getElementById("nextWalk");

        if (invites.length === 0) {
          nextWalkDiv.innerHTML = "<p>No upcoming walks booked.</p>";
          return;
        }

        const next = invites[0];
        nextWalkDiv.innerHTML = `
      <p><b>Date:</b> ${next.date}</p>
      <p><b>Slot:</b> ${next.slot}</p>
      <p><b>Status:</b> ${next.status}</p>
      <p><b>With:</b> ${next.buddyEmail}</p>
    `;
      }

      // ===== Load Buddies =====
      async function loadBuddies() {
        const res = await fetch(/invites?email=${userEmail});
        const invites = await res.json();

        const buddyList = document.getElementById("buddyList");
        buddyList.innerHTML = "";

        if (invites.length === 0) {
          buddyList.innerHTML = "<li>No buddies yet.</li>";
          return;
        }

        const buddies = new Set();
        invites.forEach((i) => {
          buddies.add(i.userEmail === userEmail ? i.buddyEmail : i.userEmail);
        });

        buddies.forEach((b) => {
          const li = document.createElement("li");
          li.textContent = b;
          buddyList.appendChild(li);
        });
      }

      // ===== Initialize Dashboard =====
      window.addEventListener("load", () => {
        if (!userEmail) {
          alert("Please log in first!");
          window.location.href = "/login.html";
          return;
        }

        loadNearby();
        loadNextWalk();
        loadBuddies();
      });
    </script>
  </body>
</html>


